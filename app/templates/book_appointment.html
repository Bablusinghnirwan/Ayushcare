{% extends 'base.html' %}

{% block content %}
<div class="mb-8">
    <h2 class="text-4xl font-bold text-white"><i class="fas fa-calendar-plus mr-3"></i>Book an Appointment</h2>
    <p class="text-gray-400 mt-2">Schedule a new consultation with a doctor.</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-1">
        <div class="glass-card">
            <h4 class="text-xl font-bold text-white mb-4">New Appointment</h4>
            <form method="post" action="{{ url_for('main.book_appointment') }}" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300">Select Doctor</label>
                    <select name="doctor" class="form-control-glass mt-1 block w-full rounded-md" required>
                        <option value="">-- Choose a Doctor --</option>
                        {% for doc in doctors %}<option value="{{ doc.id }}">Dr. {{ doc.name }} ({{ doc.specialty }})</option>{% endfor %}
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-300">Date</label><input type="date" id="date" name="date" class="form-control-glass mt-1 block w-full rounded-md" required></div>
                    <div><label class="block text-sm font-medium text-gray-300">Time</label><input type="time" name="time" class="form-control-glass mt-1 block w-full rounded-md" required></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">Mode</label>
                    <select name="mode" class="form-control-glass mt-1 block w-full rounded-md" required>
                        <option value="IN_CLINIC">In-person</option>
                        <option value="VIDEO_CALL">Video Call</option>
                        <option value="AUDIO_CALL">Audio Call</option>
                    </select>
                </div>
                <div><label class="block text-sm font-medium text-gray-300">Reason for Appointment</label><textarea name="reason" class="form-control-glass mt-1 block w-full rounded-md" required></textarea></div>
                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Book Now</button>
            </form>
        </div>
    </div>

    <div class="lg:col-span-2">
        <div class="glass-card">
            <h4 class="text-xl font-bold text-white mb-4">Your Appointments</h4>
            <ul class="space-y-4">
                {% if appointments %}
                    {% for appt in appointments %}
                    <li class="p-4 rounded-lg bg-black/20 flex justify-between items-center">
                        <div>
                            <p class="font-bold text-white">Dr. {{ appt.doctor.name }}</p>
                            <p class="text-sm text-gray-400">
                                <i class="fas fa-calendar-alt mr-2"></i>{{ appt.appointment_datetime.strftime('%d %b, %Y') }}
                                <span class="mx-2">|</span>
                                <i class="fas fa-clock mr-2"></i>{{ appt.appointment_datetime.strftime('%I:%M %p') }}
                                <span class="mx-2">|</span>
                                {% if appt.mode.name == 'VIDEO_CALL' %}<i class="fas fa-video mr-2"></i>
                                {% elif appt.mode.name == 'AUDIO_CALL' %}<i class="fas fa-phone-alt mr-2"></i>
                                {% else %}<i class="fas fa-hospital mr-2"></i>{% endif %}
                                {{ appt.mode.value }}
                            </p>
                        </div>
                        
                        <div class="appointment-status">
                            {% if appt.status.name == 'SCHEDULED' %}
                                {% if appt.mode.name == 'VIDEO_CALL' or appt.mode.name == 'AUDIO_CALL' %}
                                    <a href="https://wa.me/{{ appt.doctor.phone }}" target="_blank" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors no-underline text-sm">Start Call</a>
                                {% elif appt.mode.name == 'IN_CLINIC' %}
                                    <a href="https://maps.google.com/?q={{ appt.doctor.clinic_address | urlencode }}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors no-underline text-sm">View Map</a>
                                {% endif %}
                            {% else %}
                                <span class="text-xs font-bold uppercase py-1 px-3 rounded-full 
                                    {% if appt.status.name == 'COMPLETED' %}bg-gray-500/20 text-gray-300
                                    {% elif appt.status.name == 'CANCELLED' %}bg-red-500/20 text-red-300
                                    {% else %}bg-yellow-500/20 text-yellow-300
                                    {% endif %}">
                                    {{ appt.status.value }}
                                </span>
                            {% endif %}
                        </div>
                    </li>
                    {% endfor %}
                {% else %}
                    <li class="text-center text-gray-400">You have no appointments scheduled.</li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').setAttribute('min', today);
    });
</script>
{% endblock %}